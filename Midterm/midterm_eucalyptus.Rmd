---
title: "Midterm"
output: html_document
date: "2025-12-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
# for plotting PCA
library(ggfortify)
# for the backward model selection function called regsubsets
library(leaps)
# For negative binomial regression
library(MASS)
library(MuMIn)
```

```{r}
eucalyp <- read.csv("exam2023_data-2.csv")
eucalyp <- tibble(eucalyp)
head(eucalyp)
```
There are three columns that we will combine into one, they have the counts for eucalyptus in different sizes. We will just look at if eucalyptus is present or not, and therefore the columns are sumed into one.
```{r}
eucalyp["Total_seedings"] <- 
  eucalyp$euc_sdlgs0_50cm + 
  eucalyp$euc_sdlgs50cm.2m + 
  eucalyp$euc_sdlgs.2m

head(eucalyp)
# Check that the new column sums up to correct number of seedings
sum(eucalyp$Total_seedings)

# Sum of seedings from original columns
sum(eucalyp$euc_sdlgs0_50cm) + 
sum(eucalyp$euc_sdlgs50cm.2m) +
sum(eucalyp$euc_sdlgs.2m)
```
```{r}
# Remove the old seeding columns
eucalyp <- eucalyp |> select(!c(euc_sdlgs0_50cm,
                                euc_sdlgs50cm.2m,
                                euc_sdlgs.2m))
head(eucalyp)
```

## PCA
```{r}
#Check class in all columns
lapply(eucalyp, class)
```
```{r}
# Remove character columns that definitely not needed
eucalyp <- eucalyp |> select(!c(Date,Property,Season,SurveyID))

# Check out the two character columns
print("Unique Aspect values")
length(unique(eucalyp$Aspect))
unique(eucalyp$Aspect)
print("Unique landscape values")
length(unique(eucalyp$Landscape.position))
unique(eucalyp$Landscape.position)

# Change them into factors

eucalyp$Aspect <- as.integer(factor(eucalyp$Aspect))
eucalyp$Landscape.position <- as.integer(factor(eucalyp$Landscape.position))

# Print the new labels for Aspects and Landscape so we know wat is wat
unique(eucalyp$Aspect)
unique((eucalyp$Landscape.position))
```
Aspects\
1 0\
2 e\
3 n\
4 ne\
5 nne\
6 nw\
7 s\
8 se\
9 sw\
10 w\
\
Landscape positions\
1 crest\
2 flat\
3 slope\
4 toe_of_slope\
\
```{r}
nrow(eucalyp)
eucalyp <- na.omit(eucalyp)
nrow(eucalyp)
```

```{r}
# Do the PCA
pca_eucalyp <- prcomp(eucalyp, scale. = TRUE, center = TRUE, retx = TRUE)
names(pca_eucalyp)
summary(pca_eucalyp)

```

```{r}
# Scree plot
# npcs is nr of principal components to plot, deafult is 10
screeplot(pca_eucalyp, type = "lines", npcs = 33)

var_explained <- pca_eucalyp$sdev^2
prop_var <- var_explained / sum(var_explained)

plot(prop_var,
     type = "b",
     xlab = "Principal Component",
     ylab = "Proportion of Variance Explained",
     main = "Scree Plot")

```
```{r}
sort(abs(pca_eucalyp$rotation[,1]), decreasing = TRUE)

```

```{r}
install.packages("factoextra")
library(factoextra)
```
```{r}
# axes 1 means PC1
fviz_pca_contrib(pca_eucalyp, choice = "var", axes = 1)
```

```{r}
autoplot(pca_eucalyp, data = eucalyp, colour = "annual_precipitation")

```

Remove columns, based on what is important in PC1, and based on which variables are highly correlated plus some biological weigh-ins.
```{r}
eucalyp <- eucalyp |> select(!c(
  PET,
  precipitation_coldest_quarter,
  precipitation_warmest_quarter,
  Northing,
  Easting,
  MrVBF,
  Euc_canopy_cover
))

```

# Model selection
```{r}

backward_m <- regsubsets(
  Total_seedings~.,
  data=eucalyp,
  nvmax= 25,
  method = "backward"
  )

# Summary the model output
model_summary <- summary(backward_m)

# Look at the RSS of the model 
model_summary$rss

# Plot number of predictors against the RSS to see where the model has the best fit without being unnecessary large
plot(model_summary$rss, type = "b", xlab = "Number of predictors", ylab = "RSS")

```
```{r}
# Extract the coefficients of the "best" model
# Named numeric vector
coef_10 <- coef(backward_m, 10)
coef_10

```
```{r}
# Define the "best" formula, based on the 8 predictors
# Get variable names (excluding intercept)
best_vars <- names(coef_10)[-1]
best_vars

# Construct a formula automatically
formula_best <- as.formula(
  paste("Total_seedings~", paste(best_vars, collapse = " + "))
)

formula_best
```

Model selection with AIC instead
```{r}
# check if use poisson or negative binomial
mean(eucalyp$Total_seedings)
var(eucalyp$Total_seedings)
```

```{r}
# Orderd so that the one most important in PC1 is highest in the list
m1 <- glm.nb(Total_seedings ~ 
            annual_precipitation + 
            Litter_cover +
            Landscape.position +
            U_ppm + 
            ExoticPerennialGrass_cover + 
            NativePerennialFern_cover +
            NativePerennialGrass_cover + 
            Distance_to_Eucalypt_canopy.m. + 
            Th_ppm + 
            ExoticAnnualGrass_cover, 
            data = eucalyp)

m2 <- glm.nb(Total_seedings ~ 
            annual_precipitation + 
            Litter_cover +
            Landscape.position +
            U_ppm + 
            ExoticPerennialGrass_cover + 
            NativePerennialFern_cover +
            NativePerennialGrass_cover + 
            Distance_to_Eucalypt_canopy.m. + 
            Th_ppm,  
            data = eucalyp)

m3 <- glm.nb(Total_seedings ~ 
            annual_precipitation + 
            Litter_cover +
            Landscape.position +
            U_ppm + 
            ExoticPerennialGrass_cover + 
            NativePerennialFern_cover +
            NativePerennialGrass_cover + 
            Distance_to_Eucalypt_canopy.m., 
            data = eucalyp)

m4 <- glm.nb(Total_seedings ~ 
            annual_precipitation + 
            Litter_cover +
            Landscape.position +
            U_ppm + 
            ExoticPerennialGrass_cover + 
            NativePerennialFern_cover +
            NativePerennialGrass_cover, 
            data = eucalyp)

m5 <- glm.nb(Total_seedings ~ 
            annual_precipitation + 
            Litter_cover +
            Landscape.position +
            U_ppm + 
            ExoticPerennialGrass_cover +
            NativePerennialFern_cover, 
            data = eucalyp)

m6 <- glm.nb(Total_seedings ~ 
            annual_precipitation + 
            Litter_cover +
            Landscape.position +
            U_ppm + 
            ExoticPerennialGrass_cover,
            data = eucalyp)

m7 <- glm.nb(Total_seedings ~ 
            annual_precipitation + 
            Litter_cover +
            Landscape.position +
            U_ppm, 
            data = eucalyp)

m8 <- glm.nb(Total_seedings ~ 
            annual_precipitation + 
            Litter_cover +
            Landscape.position, 
            data = eucalyp)

m9 <- glm.nb(Total_seedings ~ 
            annual_precipitation + 
            Litter_cover, 
            data = eucalyp)

m10 <- glm.nb(Total_seedings ~ 
            annual_precipitation,
            data = eucalyp)

```

```{r}
 mlist = list(m1, m2, m3, m4, m5, m6, m7, m8, m9, m10)
 AICTab = AIC(m1, m2, m3, m4, m5, m6, m7, m8, m9, m10)
 AICTab = AICTab[order(AICTab$AIC, decreasing=F),]
 AICTab$delta = round(AICTab$AIC - min(AICTab$AIC), 2)
 lh = exp(-0.5*AICTab$delta)
 AICTab$w = round(lh/sum(lh), 2)
 
 AICTab

```
